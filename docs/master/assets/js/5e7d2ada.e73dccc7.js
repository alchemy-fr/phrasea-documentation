"use strict";(self.webpackChunkphrasea=self.webpackChunkphrasea||[]).push([[2262],{28189:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"phrasea/setup","title":"Setup (with docker-compose)","description":"Using a .env.local (custom .env)","source":"@site/docs/phrasea/setup.md","sourceDirName":"phrasea","slug":"/phrasea/setup","permalink":"/docs/phrasea/setup","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Private/public networks","permalink":"/docs/phrasea/Infra/networks"}}');var r=s(86070),a=s(6738);const l={},t="Setup (with docker-compose)",c={},o=[{value:"Using a .env.local (custom .env)",id:"using-a-envlocal-custom-env",level:2},{value:"Installation",id:"installation",level:2},{value:"Secure your installation",id:"secure-your-installation",level:3},{value:"Do install",id:"do-install",level:3},{value:"Configure Let&#39;s encrypt",id:"configure-lets-encrypt",level:3},{value:"Changing ports",id:"changing-ports",level:3},{value:"Using fixtures",id:"using-fixtures",level:3},{value:"Next:",id:"next",level:2}];function d(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"setup-with-docker-compose",children:"Setup (with docker-compose)"})}),"\n",(0,r.jsx)(n.h2,{id:"using-a-envlocal-custom-env",children:"Using a .env.local (custom .env)"}),"\n",(0,r.jsx)(n.p,{children:"It may be easier to deal with a local file to manage our env variables."}),"\n",(0,r.jsxs)(n.p,{children:["You can add your ",(0,r.jsx)(n.code,{children:".env.local"})," at the root of this project and define a command function in your ",(0,r.jsx)(n.code,{children:"~/.bashrc"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# ~/.bashrc or ~/.zshrc\nfunction dc() {\n    if [ -f .env.local ]; then\n        docker compose --env-file=.env --env-file=.env.local $@\n    else\n        docker compose $@\n    fi\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,r.jsxs)(n.blockquote,{children:["\n",(0,r.jsxs)(n.p,{children:["NB: If one of the port is already allocated, see the ",(0,r.jsx)(n.a,{href:"#changing-ports",children:"Changing ports"})," section and run command again."]}),"\n"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Pull this repository"}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"If you need a fresh version of images, build all images:"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"bin/build.sh\n"})}),"\n",(0,r.jsx)(n.h3,{id:"secure-your-installation",children:"Secure your installation"}),"\n",(0,r.jsxs)(n.p,{children:["Change all the default passwords or secrets you can see in ",(0,r.jsx)(n.code,{children:".env"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["They often start with ",(0,r.jsx)(n.code,{children:"__CHANGE_ME_"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"do-install",children:"Do install"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Run (magical) configuration for all projects:"}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"bin/setup.sh\n"})}),"\n",(0,r.jsx)(n.p,{children:"If the stack is already deployed, you should use migrate after a fresh build:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"bin/migrate.sh\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configure-lets-encrypt",children:"Configure Let's encrypt"}),"\n",(0,r.jsxs)(n.p,{children:["First, make sure you have set the ",(0,r.jsx)(n.code,{children:"PHRASEA_DOMAIN"})," to your main domain. A wildcard certificate will be generated on that domain."]}),"\n",(0,r.jsxs)(n.p,{children:["Add and configure the following lines to your ",(0,r.jsx)(n.code,{children:"env.local"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dotenv",children:"TRAEFIK_PROVIDERS_FILE_FILENAME=\nLETS_ENCRYPT_ENABLED=true\nLETS_ENCRYPT_PROVIDER=gandiv5\nLEGO_GANDIV5_API_KEY=<Your API key>\n"})}),"\n",(0,r.jsx)(n.p,{children:"Then just update the traefik container:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dc up -d traefik\n"})}),"\n",(0,r.jsx)(n.p,{children:"and wait for traefik to grab your certificate."}),"\n",(0,r.jsx)(n.p,{children:"By default, we are using Let's Encrypt's staging. To get a fresh production certificate, you should set:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-dotenv",children:"LETS_ENCRYPT_CA_SERVER=https://acme-v02.api.letsencrypt.org/directory\n"})}),"\n",(0,r.jsx)(n.h3,{id:"changing-ports",children:"Changing ports"}),"\n",(0,r.jsxs)(n.p,{children:["You can change the services port by overriding the environment variables (see ",(0,r.jsx)(n.code,{children:".env"})," file)."]}),"\n",(0,r.jsx)(n.h3,{id:"using-fixtures",children:"Using fixtures"}),"\n",(0,r.jsx)(n.p,{children:"You may want to popupate databases with a set of fixtures:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"# Be careful! This will empty the databases, insert fixtures and run bin/setup.sh again\nbin/install-fixtures.sh\n"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Read group of services documentation to customize environment variables:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"../databox/README.md",children:"databox"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"../expose/README.md",children:"expose"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"../report/README.md",children:"report"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"../uploader/README.md",children:"uploader"})}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(n.li,{children:["\n",(0,r.jsx)(n.p,{children:"Start the whole stack:"}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"dc up -d\n"})}),"\n",(0,r.jsx)(n.h2,{id:"next",children:"Next:"}),"\n",(0,r.jsxs)(n.p,{children:["If you are a developer: follow ",(0,r.jsx)(n.a,{href:"./dev.md",children:"dev setup guide"})]})]})}function h(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}}}]);